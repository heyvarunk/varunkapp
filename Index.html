<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Varun Dynamics ERP (Local)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel for JSX compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Essential for Mobile Full Height */
        html, body, #root {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent body scroll, handle inside app */
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Mobile adjustments */
        body { -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans selection:bg-blue-200">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
        import * as Lucide from 'https://esm.sh/lucide-react@0.263.1';
        
        // Firebase Imports
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, setDoc, updateDoc, deleteDoc, doc, query, onSnapshot, serverTimestamp, orderBy, where, getDoc, getDocs } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js';

        // ------------------------------------------------------------------
        // CONFIGURATION
        // ------------------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyCVmgAeNba4c5EGSSUZORuB-cZqI4ORBsc",
            authDomain: "varun-dynamics-app.firebaseapp.com",
            projectId: "varun-dynamics-app",
            storageBucket: "varun-dynamics-app.firebasestorage.app",
            messagingSenderId: "67016520294",
            appId: "1:67016520294:web:fd1299acabd1a7a6cf73a7",
            measurementId: "G-64DE9YNTWC"
        };
        // ------------------------------------------------------------------

        const APP_ID = 'varun-dynamics-local';
        const MASTER_ADMIN_EMAIL = 'info@varundynamics.in';

        // --- APP INITIALIZATION ---
        let app, auth, db, isConfigured = false;
        
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            isConfigured = true;
        } catch (e) {
            console.warn("Firebase configuration error:", e);
        }

        // --- COMPONENTS ---

        const ConfigErrorScreen = () => (
            <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4">
                <div className="bg-white rounded-xl shadow-2xl p-8 max-w-lg w-full text-center space-y-4">
                    <div className="w-16 h-16 bg-red-100 text-red-600 rounded-full mx-auto flex items-center justify-center">
                        <Lucide.AlertTriangle size={32} />
                    </div>
                    <h2 className="text-2xl font-bold text-slate-800">Connection Error</h2>
                    <p className="text-slate-600">Could not connect to Firebase.</p>
                    <button onClick={() => window.location.reload()} className="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">Retry</button>
                </div>
            </div>
        );

        const LoadingScreen = () => (
            <div className="min-h-screen bg-slate-900 flex flex-col items-center justify-center p-4">
                <div className="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                <h2 className="text-xl font-bold text-white">Loading System...</h2>
            </div>
        );

        const LoginScreen = ({ onJoin }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');

                try {
                    const normalizedEmail = email.toLowerCase().trim();
                    const userCredential = await signInWithEmailAndPassword(auth, normalizedEmail, password);
                    const user = userCredential.user;

                    if (normalizedEmail === MASTER_ADMIN_EMAIL) {
                        const adminProfile = {
                            name: 'Master Admin',
                            email: normalizedEmail,
                            role: 'Admin',
                            location: 'Headquarters',
                            photoURL: '', 
                            uid: user.uid,
                            lastActive: serverTimestamp()
                        };
                        await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'users', 'admin_master'), adminProfile, { merge: true });
                        onJoin(adminProfile);
                        return;
                    }

                    const usersRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'users');
                    const q = query(usersRef, where("email", "==", normalizedEmail));
                    const querySnapshot = await getDocs(q);

                    if (querySnapshot.empty) {
                        throw new Error("Access Denied. Your email is not registered in the system.");
                    }

                    const userDoc = querySnapshot.docs[0];
                    await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'users', userDoc.id), {
                        lastActive: serverTimestamp(),
                        uid: user.uid
                    });
                    onJoin({ ...userDoc.data(), uid: user.uid, docId: userDoc.id });

                } catch (err) {
                    console.error(err);
                    setError(err.message.replace('Firebase:', '').trim());
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-slate-900 flex flex-col items-center justify-center p-4 overflow-y-auto">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden animate-fade-in flex-shrink-0">
                        <div className="bg-blue-900 p-8 text-center relative">
                             <div className="w-16 h-16 bg-white/10 backdrop-blur-md rounded-xl mx-auto flex items-center justify-center mb-4 shadow-lg">
                                <Lucide.Briefcase className="text-white w-8 h-8" />
                            </div>
                            <h1 className="text-2xl font-bold text-white">Varun Dynamics</h1>
                            <p className="text-blue-200 text-sm mt-1">ERP Login</p>
                        </div>
                        <form onSubmit={handleLogin} className="p-8 space-y-6">
                            {error && <div className="bg-red-50 text-red-600 p-3 rounded text-sm flex items-center gap-2"><Lucide.AlertCircle size={16}/> {error}</div>}
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">Email ID</label>
                                <input type="email" required className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-base" placeholder="name@varundynamics.in" value={email} onChange={(e) => setEmail(e.target.value)} />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">Password</label>
                                <input type="password" required className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-base" placeholder="••••••••" value={password} onChange={(e) => setPassword(e.target.value)} />
                            </div>
                            <button type="submit" disabled={loading} className="w-full bg-blue-900 hover:bg-blue-800 text-white font-semibold py-3 rounded-lg transition-all flex items-center justify-center gap-2 text-base">
                                {loading ? 'Verifying...' : 'Secure Login'} <Lucide.ArrowRight size={16} />
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        // --- MODULES ---

        const AdminUserManagement = ({ allUsers, onAddUser, onDeleteUser }) => {
            const [newName, setNewName] = useState('');
            const [newEmail, setNewEmail] = useState('');
            const [newRole, setNewRole] = useState('Employee');
            const [newLocation, setNewLocation] = useState('Delhi Unit');
            const [newPhoto, setNewPhoto] = useState('');
            const [isAdding, setIsAdding] = useState(false);

            const handleAdd = (e) => {
                e.preventDefault();
                if (!newEmail || !newName) return;
                if (allUsers.some(u => u.email === newEmail)) { alert("User already exists!"); return; }
                onAddUser({ 
                    name: newName, 
                    email: newEmail.toLowerCase().trim(), 
                    role: newRole, 
                    location: newLocation, 
                    photoURL: newPhoto,
                    createdAt: serverTimestamp() 
                });
                setNewName(''); setNewEmail(''); setNewPhoto(''); setIsAdding(false);
            };

            return (
                <div className="space-y-6 pb-20 animate-fade-in">
                    <header className="flex flex-col md:flex-row justify-between md:items-center gap-4">
                        <h2 className="text-2xl font-bold text-slate-800">User Management</h2>
                        <button onClick={() => setIsAdding(!isAdding)} className="bg-blue-900 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-blue-800 transition-colors self-start md:self-auto shadow-sm">
                            {isAdding ? <Lucide.X size={18} /> : <Lucide.UserPlus size={18} />} {isAdding ? 'Cancel' : 'Add User'}
                        </button>
                    </header>
                    {isAdding && (
                        <div className="bg-white p-6 rounded-xl border border-blue-100 shadow-lg animate-fade-in">
                            <form onSubmit={handleAdd} className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input type="text" required className="w-full px-3 py-2 border rounded-lg text-base" value={newName} onChange={e => setNewName(e.target.value)} placeholder="Full Name" />
                                <input type="email" required className="w-full px-3 py-2 border rounded-lg text-base" value={newEmail} onChange={e => setNewEmail(e.target.value)} placeholder="Email" />
                                <select className="w-full px-3 py-2 border rounded-lg bg-white text-base" value={newRole} onChange={e => setNewRole(e.target.value)}>
                                    <option value="Employee">Employee</option>
                                    <option value="Manager">Manager</option>
                                    <option value="Director">Director</option>
                                    <option value="Business Partner">Business Partner</option>
                                </select>
                                <select className="w-full px-3 py-2 border rounded-lg bg-white text-base" value={newLocation} onChange={e => setNewLocation(e.target.value)}>
                                    <option value="Delhi Unit">Delhi Unit</option>
                                    <option value="Mumbai HQ">Mumbai HQ</option>
                                    <option value="Bangalore Hub">Bangalore Hub</option>
                                    <option value="Remote">Remote</option>
                                </select>
                                <div className="md:col-span-2">
                                    <input type="text" className="w-full px-3 py-2 border rounded-lg text-base" value={newPhoto} onChange={e => setNewPhoto(e.target.value)} placeholder="Profile Photo URL (Optional)" />
                                </div>
                                <button className="md:col-span-2 w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg font-medium mt-2">Confirm Registration</button>
                            </form>
                        </div>
                    )}
                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left min-w-[600px]">
                                <thead className="bg-slate-50 text-slate-500 uppercase text-xs font-semibold">
                                    <tr><th className="px-6 py-3">Employee</th><th className="px-6 py-3">Role</th><th className="px-6 py-3">Email</th><th className="px-6 py-3 text-right">Actions</th></tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                    {allUsers.map(user => (
                                        <tr key={user.id} className="hover:bg-slate-50 transition-colors">
                                            <td className="px-6 py-4 flex items-center gap-3">
                                                <div className="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center overflow-hidden flex-shrink-0">
                                                    {user.photoURL ? <img src={user.photoURL} alt="" className="w-full h-full object-cover" /> : <span className="text-xs font-bold text-slate-500">{user.name.charAt(0)}</span>}
                                                </div>
                                                <span className="font-medium text-slate-900">{user.name}</span>
                                            </td>
                                            <td className="px-6 py-4"><span className="px-2 py-1 rounded text-xs font-bold border bg-slate-100 text-slate-600 whitespace-nowrap">{user.role}</span></td>
                                            <td className="px-6 py-4 text-slate-500">{user.email}</td>
                                            <td className="px-6 py-4 text-right">
                                                {user.email !== MASTER_ADMIN_EMAIL && <button onClick={() => {if(confirm('Delete user?')) onDeleteUser(user.id)}} className="text-red-500 hover:underline">Remove</button>}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        const AttendanceModule = ({ user, attendanceLogs, onMarkAttendance }) => {
            const today = new Date().toLocaleDateString();
            const todaysLogs = attendanceLogs.filter(log => log.userId === user.uid && new Date(log.timestamp?.toDate()).toLocaleDateString() === today).sort((a, b) => b.timestamp?.toMillis() - a.timestamp?.toMillis());
            const lastStatus = todaysLogs.length > 0 ? todaysLogs[0].type : 'OUT';

            return (
                <div className="space-y-6 animate-fade-in pb-20">
                    <header><h2 className="text-2xl font-bold text-slate-800">Attendance</h2></header>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="md:col-span-2 bg-white rounded-xl shadow-sm border border-slate-200 p-6 flex flex-col items-center justify-center text-center space-y-6 min-h-[300px]">
                            <h3 className="text-lg font-medium text-slate-700">{lastStatus === 'IN' ? 'You are Clocked In' : 'You are Clocked Out'}</h3>
                            <button onClick={() => onMarkAttendance(lastStatus === 'IN' ? 'OUT' : 'IN')} className={`w-40 h-40 rounded-full flex flex-col items-center justify-center gap-2 transition-all transform active:scale-95 shadow-xl border-8 ${lastStatus === 'IN' ? 'bg-red-50 border-red-100 text-red-600' : 'bg-green-50 border-green-100 text-green-600'}`}>
                                <div className={`p-3 rounded-full ${lastStatus === 'IN' ? 'bg-red-200' : 'bg-green-200'}`}>{lastStatus === 'IN' ? <Lucide.LogOut size={24} /> : <Lucide.LogIn size={24} />}</div>
                                <span className="font-bold">{lastStatus === 'IN' ? 'PUNCH OUT' : 'PUNCH IN'}</span>
                            </button>
                        </div>
                        <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-4 h-[300px] overflow-auto">
                            <h3 className="font-semibold text-slate-700 mb-2">Today's Activity</h3>
                            {todaysLogs.length === 0 ? <p className="text-slate-400 text-sm">No records today.</p> : todaysLogs.map(log => (
                                <div key={log.id} className="flex items-center gap-3 p-2 border-b border-slate-50 last:border-0">
                                    <div className={`w-2 h-2 rounded-full ${log.type === 'IN' ? 'bg-green-500' : 'bg-red-500'}`} />
                                    <div className="text-sm"><span className="font-bold">{log.type === 'IN' ? 'IN' : 'OUT'}</span> <span className="text-slate-400 text-xs">{new Date(log.timestamp?.toDate()).toLocaleTimeString()}</span></div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const TaskBoard = ({ user, tasks, onAddTask, onUpdateTaskStatus, onDeleteTask }) => {
            const [newTaskTitle, setNewTaskTitle] = useState('');
            const [newTaskAssignee, setNewTaskAssignee] = useState('');
            const [isAdding, setIsAdding] = useState(false);
            const columns = [{ id: 'todo', label: 'To Do', color: 'bg-slate-50' }, { id: 'in_progress', label: 'In Progress', color: 'bg-blue-50' }, { id: 'done', label: 'Completed', color: 'bg-green-50' }];

            const handleAdd = (e) => {
                e.preventDefault();
                if (!newTaskTitle.trim()) return;
                onAddTask({ title: newTaskTitle, assignee: newTaskAssignee || 'Anyone', status: 'todo', createdBy: user.name, createdAt: serverTimestamp() });
                setNewTaskTitle(''); setNewTaskAssignee(''); setIsAdding(false);
            };

            return (
                <div className="space-y-6 pb-4 h-full flex flex-col animate-fade-in">
                    <header className="flex justify-between items-center">
                        <h2 className="text-2xl font-bold text-slate-800">Task Board</h2>
                        <button onClick={() => setIsAdding(!isAdding)} className="bg-blue-900 text-white px-4 py-2 rounded-lg flex items-center gap-2 shadow-sm">{isAdding ? <Lucide.X size={18}/> : <Lucide.Plus size={18}/>} <span className="hidden md:inline">New Task</span><span className="md:hidden">Add</span></button>
                    </header>
                    {isAdding && (
                        <form onSubmit={handleAdd} className="bg-white p-4 rounded-xl border border-blue-100 shadow-lg flex flex-col md:flex-row gap-3">
                            <input type="text" placeholder="Task Description" className="flex-1 px-4 py-2 border rounded-lg text-base" value={newTaskTitle} onChange={e => setNewTaskTitle(e.target.value)} autoFocus />
                            <input type="text" placeholder="Assign To (Name)" className="md:w-48 px-4 py-2 border rounded-lg text-base" value={newTaskAssignee} onChange={e => setNewTaskAssignee(e.target.value)} />
                            <button className="bg-green-600 text-white px-6 py-2 rounded-lg">Add</button>
                        </form>
                    )}
                    <div className="flex-1 overflow-x-auto pb-2">
                        <div className="flex gap-4 min-w-[800px] h-full">
                            {columns.map(col => (
                                <div key={col.id} className={`flex-1 rounded-xl p-4 flex flex-col gap-3 ${col.color} border border-slate-200`}>
                                    <h3 className="font-bold text-slate-700 border-b pb-2">{col.label}</h3>
                                    <div className="flex-1 overflow-y-auto space-y-3 custom-scrollbar">
                                        {tasks.filter(t => t.status === col.id).map(task => (
                                            <div key={task.id} className="bg-white p-3 rounded-lg shadow-sm border border-slate-100 group">
                                                <div className="flex justify-between items-start mb-1">
                                                    <p className="font-medium text-sm">{task.title}</p>
                                                    <button onClick={() => onDeleteTask(task.id)} className="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100"><Lucide.Trash2 size={14}/></button>
                                                </div>
                                                <div className="flex justify-between items-end mt-2">
                                                    <div className="text-xs bg-slate-100 px-2 py-1 rounded text-slate-600 flex items-center gap-1"><Lucide.User size={10}/> {task.assignee}</div>
                                                    {col.id !== 'done' && <button onClick={() => onUpdateTaskStatus(task.id, col.id === 'todo' ? 'in_progress' : 'done')} className="text-xs text-blue-600 hover:underline">Next &rarr;</button>}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const AvailabilityModule = ({ user, leaves, onAddLeave }) => {
            const [fromDate, setFromDate] = useState('');
            const [toDate, setToDate] = useState('');
            const [reason, setReason] = useState('');
            const handleSubmit = (e) => {
                e.preventDefault();
                if (!fromDate || !toDate) return;
                onAddLeave({ userId: user.uid, userName: user.name, location: user.location, from: fromDate, to: toDate, reason, status: 'Pending' });
                setFromDate(''); setToDate(''); setReason('');
            };

            return (
                <div className="space-y-6 pb-20 animate-fade-in">
                    <header><h2 className="text-2xl font-bold text-slate-800">Leaves & Vacancy</h2></header>
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                            <h3 className="font-semibold mb-4">Request Leave</h3>
                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div className="grid grid-cols-2 gap-2">
                                    <input type="date" required className="border p-2 rounded text-base" value={fromDate} onChange={e => setFromDate(e.target.value)} />
                                    <input type="date" required className="border p-2 rounded text-base" value={toDate} onChange={e => setToDate(e.target.value)} />
                                </div>
                                <textarea className="w-full border p-2 rounded text-base h-20" placeholder="Reason..." value={reason} onChange={e => setReason(e.target.value)} />
                                <button className="w-full bg-blue-900 text-white py-2 rounded text-sm">Submit</button>
                            </form>
                        </div>
                        <div className="lg:col-span-2 bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                            <div className="p-4 bg-slate-50 border-b border-slate-100 font-semibold text-sm">Leave History</div>
                            <div className="max-h-[300px] overflow-auto">
                                <table className="w-full text-sm text-left min-w-[500px]">
                                    <thead className="text-xs text-slate-500 uppercase bg-slate-50"><tr><th className="px-4 py-2">Name</th><th className="px-4 py-2">Dates</th><th className="px-4 py-2">Status</th></tr></thead>
                                    <tbody>
                                        {leaves.map((l, i) => (
                                            <tr key={i} className="border-b"><td className="px-4 py-2">{l.userName}</td><td className="px-4 py-2 text-xs">{l.from} to {l.to}</td><td className="px-4 py-2"><span className="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded">{l.status}</span></td></tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const EODModule = ({ user, reports, onSubmitReport }) => {
            const [content, setContent] = useState('');
            const handleSubmit = (e) => {
                e.preventDefault();
                if(!content.trim()) return;
                onSubmitReport({ userId: user.uid, userName: user.name, role: user.role, date: new Date().toLocaleDateString(), content, timestamp: serverTimestamp() });
                setContent('');
            };
            return (
                <div className="space-y-6 pb-20 animate-fade-in">
                    <header><h2 className="text-2xl font-bold text-slate-800">End of Day Reports</h2></header>
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                            <h3 className="font-semibold mb-4">Submit Report</h3>
                            <form onSubmit={handleSubmit} className="space-y-4">
                                <textarea className="w-full border p-3 rounded h-40 resize-none text-base" placeholder="Work done today..." value={content} onChange={e => setContent(e.target.value)} />
                                <button className="w-full bg-blue-900 text-white py-2 rounded text-sm">Submit</button>
                            </form>
                        </div>
                        <div className="lg:col-span-2 bg-white rounded-xl shadow-sm border border-slate-200 p-4 h-[500px] overflow-auto space-y-4">
                            <h3 className="font-semibold text-slate-800">Team Submissions</h3>
                            {reports.map(r => (
                                <div key={r.id} className="bg-slate-50 p-4 rounded border border-slate-100">
                                    <div className="flex justify-between mb-2">
                                        <span className="font-bold text-sm text-blue-900">{r.userName}</span>
                                        <span className="text-xs text-slate-400">{r.date}</span>
                                    </div>
                                    <p className="text-sm text-slate-700 whitespace-pre-wrap">{r.content}</p>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const ChatModule = ({ user, messages, onSendMessage }) => {
            const [text, setText] = useState('');
            const bottomRef = useRef(null);
            
            useEffect(() => { bottomRef.current?.scrollIntoView({ behavior: "smooth" }); }, [messages]);

            const handleSend = (e) => {
                e.preventDefault();
                if(!text.trim()) return;
                onSendMessage({ text, userId: user.uid, userName: user.name, userPhoto: user.photoURL || '', timestamp: serverTimestamp() });
                setText('');
            };

            return (
                <div className="h-[calc(100vh-140px)] md:h-[calc(100vh-100px)] flex flex-col bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden animate-fade-in">
                    <div className="p-4 bg-slate-50 border-b border-slate-200 font-bold text-slate-700 flex items-center gap-2">
                        <Lucide.MessageSquare size={18}/> Group Chat
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50/50">
                        {messages.map(m => (
                            <div key={m.id} className={`flex gap-2 ${m.userId === user.uid ? 'flex-row-reverse' : 'flex-row'}`}>
                                <div className="w-8 h-8 rounded-full bg-slate-200 flex-shrink-0 overflow-hidden">
                                     {m.userPhoto ? <img src={m.userPhoto} className="w-full h-full object-cover"/> : <div className="w-full h-full flex items-center justify-center text-xs font-bold text-slate-500">{m.userName.charAt(0)}</div>}
                                </div>
                                <div className={`max-w-[70%] p-3 rounded-lg text-sm ${m.userId === user.uid ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-white border border-slate-200 text-slate-800 rounded-tl-none'}`}>
                                    <p className="font-bold text-xs opacity-70 mb-1">{m.userName}</p>
                                    <p>{m.text}</p>
                                </div>
                            </div>
                        ))}
                        <div ref={bottomRef} />
                    </div>
                    <form onSubmit={handleSend} className="p-3 md:p-4 border-t border-slate-200 bg-white flex gap-2">
                        <input type="text" className="flex-1 border border-slate-300 rounded-full px-4 py-2 text-base md:text-sm focus:outline-none focus:border-blue-500" placeholder="Type a message..." value={text} onChange={e => setText(e.target.value)} />
                        <button className="bg-blue-600 text-white p-2 rounded-full hover:bg-blue-700 flex-shrink-0"><Lucide.Send size={18}/></button>
                    </form>
                </div>
            );
        };

        const App = () => {
            if (!isConfigured) return <ConfigErrorScreen />;

            const [user, setUser] = useState(null);
            const [profile, setProfile] = useState(null);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [sidebarOpen, setSidebarOpen] = useState(false);
            
            // Data
            const [attendanceLogs, setAttendanceLogs] = useState([]);
            const [tasks, setTasks] = useState([]);
            const [leaves, setLeaves] = useState([]);
            const [reports, setReports] = useState([]);
            const [allUsers, setAllUsers] = useState([]);
            const [messages, setMessages] = useState([]);

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, async (u) => {
                    if (u) { setUser(u); } else { setUser(null); setProfile(null); }
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user || !profile) return;
                const unsub1 = onSnapshot(collection(db, 'artifacts', APP_ID, 'public', 'data', 'attendance'), s => setAttendanceLogs(s.docs.map(d => ({id: d.id, ...d.data()}))));
                const unsub2 = onSnapshot(collection(db, 'artifacts', APP_ID, 'public', 'data', 'tasks'), s => setTasks(s.docs.map(d => ({id: d.id, ...d.data()}))));
                const unsub3 = onSnapshot(collection(db, 'artifacts', APP_ID, 'public', 'data', 'leaves'), s => setLeaves(s.docs.map(d => ({id: d.id, ...d.data()}))));
                const unsub4 = onSnapshot(query(collection(db, 'artifacts', APP_ID, 'public', 'data', 'daily_reports'), orderBy('timestamp', 'desc')), s => setReports(s.docs.map(d => ({id: d.id, ...d.data()}))));
                const unsub5 = onSnapshot(query(collection(db, 'artifacts', APP_ID, 'public', 'data', 'messages'), orderBy('timestamp', 'asc')), s => setMessages(s.docs.map(d => ({id: d.id, ...d.data()}))));
                let unsub6 = () => {};
                if (profile.role === 'Admin') {
                    unsub6 = onSnapshot(collection(db, 'artifacts', APP_ID, 'public', 'data', 'users'), s => setAllUsers(s.docs.map(d => ({id: d.id, ...d.data()}))));
                }
                return () => { unsub1(); unsub2(); unsub3(); unsub4(); unsub5(); unsub6(); };
            }, [user, profile]);

            const handleLogout = async () => { await signOut(auth); setProfile(null); };

            if (loading) return <LoadingScreen />;
            if (!user || !profile) return <LoginScreen onJoin={setProfile} />;

            const NavItem = ({ id, icon: Icon, label }) => (
                <button onClick={() => { setActiveTab(id); setSidebarOpen(false); }} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ${activeTab === id ? 'bg-blue-800 text-white' : 'text-blue-100 hover:bg-blue-900'}`}>
                    <Icon size={18} /> <span className="font-medium text-sm">{label}</span>
                </button>
            );

            return (
                <div className="h-screen bg-slate-100 flex overflow-hidden">
                    {sidebarOpen && <div className="fixed inset-0 bg-black/50 z-40 lg:hidden backdrop-blur-sm" onClick={() => setSidebarOpen(false)} />}
                    <aside className={`fixed lg:static inset-y-0 left-0 z-50 w-64 bg-blue-950 text-white flex flex-col transition-transform duration-300 shadow-2xl ${sidebarOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'}`}>
                        <div className="p-6 border-b border-blue-900">
                            <h1 className="font-bold text-lg">Varun Dynamics</h1>
                            <div className="mt-4 flex items-center gap-3 bg-blue-900/50 p-2 rounded border border-blue-800">
                                <div className="w-8 h-8 rounded bg-blue-500 flex items-center justify-center font-bold text-xs overflow-hidden">
                                    {profile.photoURL ? <img src={profile.photoURL} className="w-full h-full object-cover"/> : profile.name.charAt(0)}
                                </div>
                                <div><p className="font-bold text-sm truncate w-24">{profile.name}</p><p className="text-xs text-blue-300">{profile.role}</p></div>
                            </div>
                        </div>
                        <nav className="flex-1 px-4 py-4 space-y-1 overflow-y-auto">
                            <NavItem id="dashboard" icon={Lucide.LayoutDashboard} label="Dashboard" />
                            <NavItem id="attendance" icon={Lucide.Clock} label="Attendance" />
                            <NavItem id="tasks" icon={Lucide.CheckSquare} label="Task Board" />
                            <NavItem id="eod" icon={Lucide.FileText} label="Daily Reports" />
                            <NavItem id="leaves" icon={Lucide.CalendarDays} label="Leaves" />
                            <NavItem id="chat" icon={Lucide.MessageSquare} label="Group Chat" />
                            {profile.role === 'Admin' && <NavItem id="users" icon={Lucide.Users} label="User Management" />}
                        </nav>
                        <div className="p-4 border-t border-blue-900"><button onClick={handleLogout} className="w-full flex items-center justify-center gap-2 bg-blue-900 hover:bg-red-600 transition-colors py-2 rounded-lg text-sm"><Lucide.LogOut size={16} /> Sign Out</button></div>
                    </aside>

                    <main className="flex-1 flex flex-col h-screen overflow-hidden">
                        <header className="bg-white border-b border-slate-200 p-4 flex items-center justify-between lg:hidden shadow-sm z-30 relative">
                            <button onClick={() => setSidebarOpen(true)} className="text-slate-600 p-2"><Lucide.Menu size={24} /></button>
                            <span className="font-bold text-slate-800">Varun Dynamics</span>
                            <div className="w-8" />
                        </header>
                        <div className="flex-1 overflow-auto bg-slate-50 p-4 lg:p-8">
                            <div className="max-w-6xl mx-auto h-full">
                                {activeTab === 'dashboard' && (
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 animate-fade-in">
                                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200"><p className="text-slate-500 text-xs font-bold uppercase">Attendance</p><p className="text-2xl font-bold text-slate-800">{attendanceLogs.some(l => l.userId === user.uid && new Date(l.timestamp?.toDate()).toDateString() === new Date().toDateString()) ? 'Present' : 'Absent'}</p></div>
                                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200"><p className="text-slate-500 text-xs font-bold uppercase">Pending Tasks</p><p className="text-2xl font-bold text-slate-800">{tasks.filter(t => t.status !== 'done').length}</p></div>
                                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200"><p className="text-slate-500 text-xs font-bold uppercase">Reports Today</p><p className="text-2xl font-bold text-slate-800">{reports.length}</p></div>
                                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200"><p className="text-slate-500 text-xs font-bold uppercase">On Leave</p><p className="text-2xl font-bold text-slate-800">{leaves.length}</p></div>
                                    </div>
                                )}
                                {activeTab === 'users' && profile.role === 'Admin' && <AdminUserManagement allUsers={allUsers} onAddUser={(data) => addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'users'), data)} onDeleteUser={(id) => deleteDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'users', id))} />}
                                {activeTab === 'attendance' && <AttendanceModule user={{...profile, uid: user.uid}} attendanceLogs={attendanceLogs} onMarkAttendance={(type) => addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'attendance'), { userId: user.uid, userName: profile.name, location: profile.location, type, timestamp: serverTimestamp() })} />}
                                {activeTab === 'tasks' && <TaskBoard user={{...profile, uid: user.uid}} tasks={tasks} onAddTask={(data) => addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'tasks'), data)} onUpdateTaskStatus={(id, status) => updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'tasks', id), {status})} onDeleteTask={(id) => deleteDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'tasks', id))} />}
                                {activeTab === 'leaves' && <AvailabilityModule user={{...profile, uid: user.uid}} leaves={leaves} onAddLeave={(data) => addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'leaves'), data)} />}
                                {activeTab === 'eod' && <EODModule user={{...profile, uid: user.uid}} reports={reports} onSubmitReport={(data) => addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'daily_reports'), data)} />}
                                {activeTab === 'chat' && <ChatModule user={{...profile, uid: user.uid}} messages={messages} onSendMessage={(data) => addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'messages'), data)} />}
                            </div>
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>